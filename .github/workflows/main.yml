name: Publish Docker image

on: [push]

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
        - uses: actions/checkout@v1
        - name: Publish docker image 
          uses: saubermacherag/ansible-playbook-docker-action@v1.2
          with:
            playbookName: '.ansible/publish-image.yml'
            extraVars: "-e docker_username=${{ secrets.DOCKER_USERNAME }} -e docker_password=${{ secrets.DOCKER_PASSWORD }}"
  
  deploy:

    runs-on: ubuntu-latest
    steps:
        - uses: actions/checkout@v1
        
        - name: Add private key to ssh-agent
          run: 
            - echo "${{ secrets.SSH_PRIVATE_KEY }}" >> /github/home/key.pem 
            - chmod 700 /github/home/key.pem 
        
        - name: Pulling docker image 
          uses: saubermacherag/ansible-playbook-docker-action@v1.2
          with:
            playbookName: '.ansible/upload-to-server.yml'
            inventoryFile: '.ansible/production/inventory.yml'
            keyFile: '/github/home/key.pem'
            extraVars: "-e docker_username=${{ secrets.DOCKER_USERNAME }} -e docker_password=${{ secrets.DOCKER_PASSWORD }}" 
